<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading History</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

<style>
*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:"Segoe UI",Arial,sans-serif;
}

body{
background:#f4f6f9;
color:#1f2937;
}

/* HEADER */
header{
background:#ffffff;
height:60px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 25px;
border-bottom:1px solid #e5e7eb;
box-shadow:0 2px 8px rgba(0,0,0,0.05);
}

.logo{
color:#2563eb;
font-weight:700;
font-size:1.2rem;
}

.header-nav a{
text-decoration:none;
color:#374151;
font-weight:500;
margin-right:15px;
transition:.2s;
}

.header-nav a:hover{
color:#2563eb;
}

.logout-btn{
padding:6px 12px;
background:#dc2626;
color:white;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:600;
}

.logout-btn:hover{
background:#b91c1c;
}

/* LAYOUT */
#layout{
display:grid;
grid-template-columns:220px 1fr;
height:calc(100vh - 60px);
}

/* SIDEBAR */
#sidebar{
background:#ffffff;
border-right:1px solid #e5e7eb;
padding:15px;
}

.navBtn{
display:block;
padding:10px 12px;
margin-bottom:10px;
background:#f9fafb;
border-radius:8px;
text-decoration:none;
color:#374151;
transition:.25s;
font-weight:500;
}

.navBtn:hover{
background:#e0e7ff;
color:#1d4ed8;
}

/* MAIN CONTENT */
.main{
padding:40px;
overflow:auto;
}

h2{
color:#2563eb;
margin-bottom:20px;
font-weight:700;
}

/* Buttons */
.buttonGroup{
margin-bottom:15px;
}

button{
padding:9px 16px;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:600;
margin-right:10px;
transition:.2s;
}

button:hover{
transform:translateY(-2px);
box-shadow:0 5px 15px rgba(0,0,0,0.15);
}

.exportBtn{
background:#2563eb;
color:white;
}

.deleteBtn{
background:#dc2626;
color:white;
}

/* Table */
table{
width:100%;
border-collapse:collapse;
margin-top:20px;
background:#ffffff;
border-radius:10px;
overflow:hidden;
box-shadow:0 6px 18px rgba(0,0,0,0.05);
}

th,td{
padding:12px;
text-align:center;
border-bottom:1px solid #e5e7eb;
}

th{
background:#f9fafb;
color:#2563eb;
font-weight:600;
}

tr:hover{
background:#f3f4f6;
}

input[type="checkbox"]{
width:16px;
height:16px;
cursor:pointer;
}

.pnl-positive{
color:#16a34a;
font-weight:600;
}

.pnl-negative{
color:#dc2626;
font-weight:600;
}

@media(max-width:768px){
.main{padding:15px;}
table{font-size:13px;}
}
</style>
</head>

<body>

<header>
<div style="display:flex;align-items:center;">
<div class="logo">TRADING SIMULATOR</div>
</div>

<button class="logout-btn" onclick="logout()">Logout</button>
</header>

<div id="layout">

<!-- SIDEBAR -->
<div id="sidebar">
<a href="trade.html" class="navBtn">ðŸ“ˆ Trade</a>
<a href="profile.html" class="navBtn">ðŸ‘¤ Profile</a>
<a href="history.html" class="navBtn">ðŸ“œ History</a>
</div>

<!-- MAIN CONTENT -->
<div class="main">

<h2>Trading History</h2>

<div class="buttonGroup">
<button class="exportBtn" onclick="exportPDF()">Export PDF</button>
<button class="deleteBtn" onclick="deleteSelected()">Delete Selected</button>
</div>

<table>
<thead>
<tr>
<th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
<th>Type</th>
<th>Qty</th>
<th>Price</th>
<th>PnL</th>
<th>Date</th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>

</div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://nxwcekpehqmdkelyrzqf.supabase.co",
  "sb_publishable_bjF_z3_ZDaKRTByS4jWfyA_6U12XYtu"
);

let userId = sessionStorage.getItem('userId');
let transactionData = [];

if (!userId) {
  alert("User not logged in");
  window.location.href = "index.html";
}

function logout(){
sessionStorage.removeItem("userId");
window.location.href="index.html";
}

// LOAD HISTORY
async function loadHistory(){
  const { data, error } = await supabaseClient
    .from('transactions')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });

  if (error) {
    alert("Error loading history");
    return;
  }

  transactionData = data || [];
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';

  transactionData.forEach(tr => {
    const pnlClass = tr.pnl >= 0 ? "pnl-positive" : "pnl-negative";

    tbody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck" value="${tr.id}"></td>
        <td>${tr.type}</td>
        <td>${tr.qty ?? '-'}</td>
        <td>${tr.price ?? '-'}</td>
        <td class="${pnlClass}">${tr.pnl ?? 0}</td>
        <td>${new Date(tr.created_at).toLocaleString()}</td>
      </tr>
    `;
  });
}
loadHistory();

// SELECT ALL
function toggleSelectAll(source){
  document.querySelectorAll(".rowCheck").forEach(cb=>{
    cb.checked = source.checked;
  });
}

// DELETE
async function deleteSelected(){
  const checked = document.querySelectorAll(".rowCheck:checked");
  if(checked.length === 0){
    alert("No rows selected");
    return;
  }

  const ids = Array.from(checked).map(cb => cb.value);

  const { error } = await supabaseClient
    .from('transactions')
    .delete()
    .in('id', ids);

  if(error){
    alert("Error deleting records");
    return;
  }

  alert("Selected records deleted successfully");
  loadHistory();
}

// EXPORT PDF
function exportPDF() {
  if (transactionData.length === 0) {
    alert("No data to export");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"landscape", unit:"mm", format:"a4" });

  doc.setFontSize(14);
  doc.text("Trading History Report",14,15);
  doc.text("National Stock Exchange (NSE) & Bitcoin",14,22);

  const tableColumn = ["Type","Qty","Price","PnL","Date"];
  const tableRows = [];

  transactionData.forEach(tr=>{
    tableRows.push([
      tr.type,
      tr.qty ?? '-',
      tr.price ?? '-',
      tr.pnl ?? 0,
      new Date(tr.created_at).toLocaleString()
    ]);
  });

  doc.autoTable({
    head:[tableColumn],
    body:tableRows,
    startY:30,
    theme:"grid",
    styles:{ halign:'center' }
  });

  doc.save("Trading_History.pdf");
}
</script>

</body>
</html>