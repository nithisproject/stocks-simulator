<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Simulator</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{margin:0;background:linear-gradient(135deg,#0b0e11,#13161c);color:#e6edf3;font-family:"Segoe UI",Arial,sans-serif;}
header{background:#11161c;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid #1f2933;}
.logo{color:#ff9800;font-weight:bold;font-size:1.3rem;}

#layout{display:grid;grid-template-columns:200px 1fr 320px;height:calc(100vh-60px);}
#sidebar{background:#11161c;border-right:1px solid #1f2933;padding:15px;}
#center{display:flex;flex-direction:column;}
#right{background:#11161c;border-left:1px solid #1f2933;padding:15px;}

.navBtn{display:block;padding:10px;margin-bottom:10px;background:#0f141a;border-radius:6px;text-decoration:none;color:#fff;}
.navBtn:hover{background:#1e2730;}

.panel{background:#0f141a;border:1px solid #1e2730;border-radius:8px;padding:12px;margin-bottom:12px;}

button{padding:8px;margin:4px 0;border:none;border-radius:6px;cursor:pointer;font-weight:bold;}
.buy{background:#00c853;}
.sell{background:#ff5252;}
.blue{background:#2962ff;}

input{width:75%;padding:8px;margin:5px 0;background:#0b0e11;border:1px solid #333;color:#fff;border-radius:6px;}

#bottomPanel{height:200px;background:#0f141a;border-top:1px solid #1f2933;display:flex;flex-direction:column;}
.tabs{display:flex;border-bottom:1px solid #1f2933;}
.tabBtn{flex:1;padding:8px;background:#11161c;border:none;color:#aaa;cursor:pointer;}
.tabBtn.active{background:#0f141a;color:#00e5ff;}
.tabContent{flex:1;overflow:auto;padding:10px;font-size:14px;}
</style>
</head>

<body>

<header>
<div class="logo">TRADING SIMULATOR</div>
<div>Balance ₹<span id="balTop">0</span> | PnL <span id="pnlTop">0</span></div>
</header>

<div id="layout">

<!-- SIDEBAR -->
<div id="sidebar">

<a href="trade.html" class="navBtn">Trade</a>
<a href="profile.html" class="navBtn">Profile</a>
<a href="history.html" class="navBtn">History</a>

<div class="panel">
<h3>NSE Data</h3>
From
<input type="date" id="fromDate">
To
<input type="date" id="toDate">
<button class="blue" onclick="loadFromDatabase()">Load Data</button>
</div>

</div>

<!-- CENTER -->
<div id="center">
<div style="flex:1;padding:10px;">
<canvas id="chart"></canvas>
</div>

<div id="bottomPanel">
<div class="tabs">
<button class="tabBtn active" onclick="showTab('trades',event)">Trades</button>
<button class="tabBtn" onclick="showTab('positions',event)">Positions</button>
<button class="tabBtn" onclick="showTab('orders',event)">Orders</button>
</div>

<div id="trades" class="tabContent"></div>
<div id="positions" class="tabContent" style="display:none"></div>
<div id="orders" class="tabContent" style="display:none"></div>

</div>
</div>

<!-- RIGHT PANEL -->
<div id="right">

<div class="panel">
Qty
<input id="qty" type="number" value="1">
Limit
<input id="limit" type="number">

<button class="buy" onclick="buyMarket()">BUY</button>
<button class="sell" onclick="sellMarket()">SELL</button>
<button class="blue" onclick="buyLimit()">LIMIT BUY</button>
<button class="blue" onclick="sellLimit()">LIMIT SELL</button>
</div>

<div class="panel">
Balance ₹<span id="bal">0</span><br>
Position <span id="pos">0</span><br>
Avg <span id="avg">0</span><br>
PnL <span id="pnl">0</span>
</div>

</div>
</div>

<script>
 const supabaseClient = window.supabase.createClient(
    "https://nxwcekpehqmdkelyrzqf.supabase.co",
    "sb_publishable_bjF_z3_ZDaKRTByS4jWfyA_6U12XYtu"
  );

let userId=sessionStorage.getItem('userId');
let price=0,dataSeries=[],pointer=0,candles=[];
let balance=0,position=0,avgPrice=0;
let openOrders=[],tradeHistory=[];
async function saveTransaction(type, quantity, tradePrice, pnlValue = 0) {
  if (!userId) {
    alert("User not logged in");
    return;
  }

  const { error } = await supabaseClient
    .from("transactions")
    .insert([
      {
        user_id: userId,
        type: type,
        qty: quantity,
        price: tradePrice,
        pnl: pnlValue
      }
    ]);

  if (error) {
    console.error("Transaction insert error:", error);
  } else {
    console.log("Transaction saved");
  }
}
// Tabs
function showTab(id,e){
document.querySelectorAll(".tabContent").forEach(d=>d.style.display="none");
document.getElementById(id).style.display="block";
document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
e.target.classList.add("active");
}

// Load Fund
async function loadFund(){
const {data}=await supabaseClient.from('funds').select('*').eq('user_id',userId).single();
if(data){balance=parseFloat(data.balance);updateUI();}
}
loadFund();

// Chart
const ctx=document.getElementById("chart").getContext("2d");
const chart=new Chart(ctx,{
type:"line",
data:{labels:[],datasets:[{data:[],borderColor:"#00e5ff",pointRadius:0}]},
options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false}}}
});

// Load NSE
// LOAD FROM NSE TABLE
async function loadFromDatabase() {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  if (!from || !to) {
    alert("Select both dates");
    return;
  }

  try {
    // Fetch all rows from the NSE table
    const { data, error, status } = await supabaseClient
      .from("nse")          // make sure table name is exactly "nse"
      .select("*");

    if (error) {
      console.error("Supabase error:", error);
      alert("Error fetching NSE data. Check console.");
      return;
    }

    if (!data || data.length === 0) {
      alert("No data in NSE table");
      return;
    }

    // Convert input dates to Date objects
    const fromDate = new Date(from);
    const toDate = new Date(to);

    // Filter manually in JS
    const filtered = data.filter(row => {
      // Ensure the trade_date exists and is parseable
      if (!row.trade_date) return false;
      const rowDate = new Date(row.trade_date);
      return rowDate >= fromDate && rowDate <= toDate;
    });

    if (filtered.length === 0) {
      alert("No data found in selected range");
      return;
    }

    // Sort by date ascending
    filtered.sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date));

    // Prepare simulation data
    dataSeries = filtered.map(row => ({
      date: row.trade_date,
      open: row.open,
      high: row.high,
      low: row.low,
      close: row.close
    }));

    pointer = 0;
    candles = [];
    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.update();

    loop();
  } catch (err) {
    console.error("Unexpected error:", err);
    alert("Unexpected error fetching NSE data. Check console.");
  }
}

// Trading
function qty(){return +document.getElementById("qty").value;}
function limit(){return +document.getElementById("limit").value;}

function logTrade(type,q,p){
tradeHistory.push(`${type} ${q} @ ${p.toFixed(2)}`);
document.getElementById("trades").innerHTML=tradeHistory.join("<br>");
renderPositions();
renderOrders();
}

async function buyMarket() {
  let q = qty();
  let cost = q * price;

  if (balance >= cost) {
    balance -= cost;

    avgPrice = ((avgPrice * position) + (price * q)) / (position + q);
    position += q;

    logTrade("BUY", q, price);
    updateUI();

    await saveTransaction("BUY", q, price, 0);
  }
}

async function sellMarket() {
  let q = qty();

  if (position >= q) {
    let realizedPnl = (price - avgPrice) * q;

    balance += q * price;
    position -= q;

    logTrade("SELL", q, price);

    if (position === 0) avgPrice = 0;

    updateUI();

    await saveTransaction("SELL", q, price, realizedPnl);
  }
}

function buyLimit(){openOrders.push({type:"BUY",qty:qty(),price:limit()});renderOrders();}
function sellLimit(){openOrders.push({type:"SELL",qty:qty(),price:limit()});renderOrders();}

function renderOrders(){
document.getElementById("orders").innerHTML=openOrders.map(o=>`${o.type} ${o.qty} @ ${o.price}`).join("<br>");
}

function renderPositions(){
document.getElementById("positions").innerHTML=`Qty: ${position}<br>Avg: ${avgPrice.toFixed(2)}`;
}

function updateUI(){
document.getElementById("bal").innerText=balance.toFixed(2);
document.getElementById("balTop").innerText=balance.toFixed(2);
document.getElementById("pos").innerText=position;
document.getElementById("avg").innerText=avgPrice.toFixed(2);
let pnl=position*(price-avgPrice);
document.getElementById("pnl").innerText=pnl.toFixed(2);
document.getElementById("pnlTop").innerText=pnl.toFixed(2);
}

function loop(){
if(pointer>=dataSeries.length)return;
let row=dataSeries[pointer++];
price=row.close;
candles.push(price);
if(candles.length>300)candles.shift();
chart.data.labels=candles.map((_,i)=>i);
chart.data.datasets[0].data=candles;
chart.update();
updateUI();
setTimeout(loop,1800);
}
</script>
</body>
</html>