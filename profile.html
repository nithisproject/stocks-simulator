<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:"Segoe UI",Arial,sans-serif;
}

body{
background:#f4f6f9;
color:#1f2937;
animation:fadePage .6s ease;
}

@keyframes fadePage{
from{opacity:0;transform:translateY(10px);}
to{opacity:1;transform:translateY(0);}
}

.container{
max-width:900px;
margin:50px auto;
padding:20px;
}

/* Title */
h2{
color:#2563eb;
margin-bottom:25px;
font-weight:700;
letter-spacing:.5px;
}

/* Cards */
.card{
background:#ffffff;
border:1px solid #e5e7eb;
border-radius:12px;
padding:25px;
margin-bottom:25px;
box-shadow:0 6px 18px rgba(0,0,0,0.05);
transition:all .25s ease;
}

.card:hover{
transform:translateY(-4px);
box-shadow:0 12px 28px rgba(0,0,0,0.08);
}

/* Balance Highlight */
.balanceBox{
font-size:32px;
font-weight:700;
color:#2563eb;
margin-top:10px;
}

/* Labels */
label{
display:block;
margin-top:14px;
margin-bottom:6px;
color:#6b7280;
font-weight:500;
}

/* Inputs */
input{
width:100%;
padding:12px;
border-radius:10px;
border:1px solid #d1d5db;
background:#ffffff;
color:#111827;
outline:none;
transition:all .25s ease;
}

input:focus{
border-color:#2563eb;
box-shadow:0 0 0 3px rgba(37,99,235,0.2);
}

/* Buttons */
button{
padding:12px 20px;
border:none;
border-radius:10px;
cursor:pointer;
font-weight:600;
margin-top:15px;
transition:all .2s ease;
}

button:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(0,0,0,0.15);
}

button:active{
transform:scale(.97);
}

/* Primary */
.primary{
background:#2563eb;
color:white;
}
.primary:hover{
background:#1d4ed8;
}

/* Deposit */
.depositBtn{
background:#16a34a;
color:white;
}
.depositBtn:hover{
background:#15803d;
}

/* Withdraw */
.withdrawBtn{
background:#dc2626;
color:white;
}
.withdrawBtn:hover{
background:#b91c1c;
}

/* Row */
.row{
display:flex;
gap:15px;
margin-top:15px;
}

.row input{
flex:1;
}

/* Messages */
.success{
color:#16a34a;
margin-top:12px;
font-weight:500;
animation:fadeMsg .4s ease;
}

.error{
color:#dc2626;
margin-top:12px;
font-weight:500;
animation:fadeMsg .4s ease;
}

@keyframes fadeMsg{
from{opacity:0;transform:translateY(5px);}
to{opacity:1;transform:translateY(0);}
}
</style>
</head>

<body>

<div class="container">

<h2>Profile Dashboard</h2>

<div class="card">
  <div>Current Balance</div>
  <div class="balanceBox">â‚¹<span id="bal">0</span></div>
</div>

<div class="card">
  <h3>Account Details</h3>

  <label>Name</label>
  <input id="name">

  <label>Email</label>
  <input id="email">

  <label>Password</label>
  <input id="password" type="password">

  <button class="primary" onclick="updateProfile()">Update Profile</button>
  <div id="profileMsg"></div>
</div>

<div class="card">
  <h3>Wallet</h3>

  <div class="row">
    <input type="number" id="amount" placeholder="Enter Amount">
  </div>

  <div class="row">
    <button class="depositBtn" onclick="deposit()">Deposit</button>
    <button class="withdrawBtn" onclick="withdraw()">Withdraw</button>
  </div>

  <div id="walletMsg"></div>
</div>

</div>

<script>
const supabaseClient = window.supabase.createClient(
  "https://nxwcekpehqmdkelyrzqf.supabase.co",
    "sb_publishable_bjF_z3_ZDaKRTByS4jWfyA_6U12XYtu"
);

let userId = sessionStorage.getItem('userId');
let balance = 0;

if(!userId){
  alert("User not logged in");
  window.location.href="login.html";
}

// ================= LOAD PROFILE =================
async function loadProfile(){
  const { data: user } = await supabaseClient
    .from('users')
    .select('*')
    .eq('id', userId)
    .single();

  const { data: fund } = await supabaseClient
    .from('funds')
    .select('*')
    .eq('user_id', userId)
    .single();

  if(user){
    document.getElementById('name').value = user.name || '';
    document.getElementById('email').value = user.email || '';
  }

  if(fund){
    balance = parseFloat(fund.balance) || 0;
    document.getElementById('bal').innerText = balance.toFixed(2);
  }
}
loadProfile();

// ================= UPDATE PROFILE =================
async function updateProfile(){
  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const { error } = await supabaseClient
    .from('users')
    .update({ name, email, password })
    .eq('id', userId);

  const msg = document.getElementById('profileMsg');

  if(error){
    msg.className="error";
    msg.innerText="Update failed!";
  } else {
    msg.className="success";
    msg.innerText="Profile updated successfully!";
  }
}

// ================= DEPOSIT =================
async function deposit(){
  const amt = parseFloat(document.getElementById('amount').value);
  const msg = document.getElementById('walletMsg');

  if(!amt || amt<=0){
    msg.className="error";
    msg.innerText="Invalid amount";
    return;
  }

  balance += amt;

  await supabaseClient.from('funds')
    .update({ balance })
    .eq('user_id', userId);

  await supabaseClient.from('transactions')
    .insert([{ user_id:userId, type:'DEPOSIT', qty:null, price:null, pnl:amt }]);

  document.getElementById('bal').innerText = balance.toFixed(2);

  msg.className="success";
  msg.innerText="Deposit successful!";
}

// ================= WITHDRAW =================
async function withdraw(){
  const amt = parseFloat(document.getElementById('amount').value);
  const msg = document.getElementById('walletMsg');

  if(!amt || amt<=0 || amt>balance){
    msg.className="error";
    msg.innerText="Invalid amount";
    return;
  }

  balance -= amt;

  await supabaseClient.from('funds')
    .update({ balance })
    .eq('user_id', userId);

  await supabaseClient.from('transactions')
    .insert([{ user_id:userId, type:'WITHDRAW', qty:null, price:null, pnl:-amt }]);

  document.getElementById('bal').innerText = balance.toFixed(2);

  msg.className="success";
  msg.innerText="Withdraw successful!";
}
</script>

</body>
</html>